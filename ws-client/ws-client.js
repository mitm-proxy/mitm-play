(()=>{var y=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var K=y((De,D)=>{D.exports=()=>{function n(e){window.mitm.client.postmessage&&console.log(`>>> Postmessage: ${e.origin} => https://${location.host}`,e.data)}window.addEventListener("message",n,!1)}});var G=y((Ke,U)=>{U.exports=()=>{let n;return{_help({data:e}){console.log(e)},_ping({data:e}){console.log(e)},_open({data:e}){let t="directories=0,titlebar=0,toolbar=0,location=0,status=0,menubar=0,width=800,height=600";n=window.open(e.url,"_logs",t),n.blur()},_style({data:e}){let{q:t,css:o}=e;document.querySelectorAll(t).forEach(c=>c.style.cssText=o)},_saveTags({routes:e}){location.origin.match("chrome-extension")||(window.mitm.routes=e)},_files({data:e,typ:t}){let{files:o}=window.mitm;console.warn(`receive brodcast ${t}`);for(let c in o[`${t}_events`])console.warn(o[`${t}_events`][c]+""),o[`${t}_events`][c](e)},_setClient({data:e}){console.log("_setClient",e),window.mitm.client=e}}}});var Y=y((Ue,W)=>{var he=G(),j=he();W.exports=(n,e)=>{window.mitm.argv.debug&&(e.length>40?console.log(">>> ws-message: `%s...`",e.slice(0,40)):console.log(">>> ws-message: `%s`",e));let t=e.replace(/\s+$/,"").match(/^ *([\w:]+) *(\{.*)/);if(t){let[,o,c]=t;try{typeof c=="string"&&(c=JSON.parse(c))}catch(s){console.error(c,s)}if(window._ws_queue[o]){let s=window._ws_queue[o];delete window._ws_queue[o],s(c.data)}else j[o]&&j[o].call(n,c)}}});var Q=y((Ge,F)=>{F.exports=()=>{let n;try{n=window.self!==window.top}catch(e){n=!0}return n?"iframe":"window"}});var X=y((We,V)=>{var ye=Y(),ve=Q();V.exports=()=>{window._ws_queue={},window._ws_connected=!1;let{__flag:n}=window.mitm;window._ws_connect===void 0&&(window._ws_connect={});let e=d=>{function u(){for(let _ in window._ws_connect)window._ws_connected_send=!0,console.warn(window._ws_connect[_]+""),window._ws_connect[_](d)}n["ws-connect"]&&console.log("ws: open connection"),console.timeEnd("ws"),window._ws_connected=!0,setTimeout(u,1),setTimeout(()=>{window._ws_connected_send||(console.error("RETRY.........."),u())},10)},t=function(){n["ws-connect"]&&console.log("ws: close connection")},o=function(d){ye(event,event.data)},c=`wss://localhost:3001/ws?page=${ve()}&url=${document.URL.split("?")[0]}`,s=new WebSocket(c);console.time("ws"),window._ws=s,s.onopen=e,s.onclose=t,s.onmessage=o,n["ws-connect"]&&console.log("ws: init connection")}});var S=y((je,Z)=>{Z.exports=()=>{let{hostname:n}=location,e;function t(o){return o.replace(/\./g,"\\.").replace(/\?/g,"\\?")}for(let o in window.mitm.routes)if(n.match(t(o.replace(/~/,"[^.]*")))){e=o;break}return e}});var O=y((Ye,ee)=>{ee.exports=()=>{let{vendor:n}=navigator;return{"":"firefox","Google Inc.":"chromium","Apple Computer, Inc.":"webkit"}[n]}});var oe=y((Fe,te)=>{var ne=S(),be=O(),E;function xe(n){if(mitm.argv.lazyclick){if(mitm.screenshot){window.mitm.screenshot=void 0,console.log(">>> delay action");return}if(E){E=void 0;return}}let e=ne(),t=be(),o=location.origin.replace("://","~~"),c=window.mitm.routes[e],{selector:s}=c.screenshot,d=document.body.querySelectorAll(s),u=location.pathname.replace(/^\//g,"~"),_=mitm.argv.lazyclick===!0?700:mitm.argv.lazyclick;for(let p of d){let r=n.target;for(;p!==r&&r!==document.body;)r=r.parentNode;if(r!==document.body){let h=window["xplay-page"],w={namespace:e,_page:h,host:o,browser:t};w.fname=u==="~"?"~_":u,window.ws__send("screenshot",w),mitm.argv.lazyclick&&(window.mitm.screenshot=n.target,n.stopImmediatePropagation(),n.stopPropagation(),n.preventDefault(),setTimeout(()=>{E=window.mitm.screenshot,E?(E.click(),E=void 0):console.log("delay action undefined")},_));return}}}te.exports=()=>{let n=window.mitm.routes[ne()];n&&n.screenshot&&window.addEventListener("DOMContentLoaded",()=>{document.querySelector("body").addEventListener("click",xe)})}});var ie=y((Qe,se)=>{var qe=S(),ke=O();se.exports=()=>{let n="position: fixed;z-index: 9999;right: 3px;",e="position: fixed;z-index: 9999;left:  3px;",t="position: fixed;z-index: 9999;right: 3px; top: 20px; text-align: end;",o="border: none;border-radius: 15px;font-size: 10px;cursor: pointer;",c=new Event("urlchanged"),s={right3:{},right:{},left:{}},d=!1,u={},_={right3:{},right:{},left:{}},p;function r(i){let[l,a]=i.split("=>").map(m=>m.trim());return l=l.replace(/\./g,"\\.").replace(/\?/g,"\\?"),{path:l,msg:a}}function h(i,l){let a;for(let m in i){let[g,f,q]=m.split("|"),b=document.createElement("button"),C=i[m];b.onclick=N=>{let M=C(N);Array.isArray(M)&&x(M)},b.innerText=g,b.classList.add("mitm-btn"),b.classList.add(`${l}`),b.classList.add(q||g),b.style=o+(f?`background: ${f};`:""),_[l].appendChild(b),l==="right"?(a=document.createElement("span"),a.innerHTML="&nbsp;"):(a=document.createElement("pre"),a.style="margin: 0px;"),_[l].appendChild(a)}}function w(i,l){_[l]&&(_[l].innerHTML="",h(i,l))}let v;function $(i){let l=qe();if(window.mitm.autofill&&delete window.mitm.autofill,window.mitm.autointerval&&(clearInterval(p),delete window.mitm.autointerval),window.mitm.autobuttons&&delete window.mitm.autobuttons,window.mitm.rightbuttons&&delete window.mitm.rightbuttons,window.mitm.leftbuttons&&delete window.mitm.leftbuttons,window.mitm.macrokeys&&delete window.mitm.macrokeys,l){let{href:m,origin:g}=T,f=m.replace(g,""),{_macros_:q,macros:b}=window.mitm;for(let C in b){let{path:N,msg:M}=r(C);f.match(N)&&(u.innerHTML=M||"Autofill",q&&q(),b[C](),v&&(clearTimeout(v),v=void 0),v=setTimeout(()=>{let{autobuttons:J,rightbuttons:B,leftbuttons:P}=window.mitm;B&&w(B,"right3"),J&&w(J,"right"),P&&w(P,"left")},0))}}s.right3.style=t,s.right.style=n,s.left.style=e;let a=window.mitm.autofill;u.style=o+(a?"background-color: azure;":"display: none;"),typeof window.mitm.autointerval=="function"&&(p=setInterval(window.mitm.autointerval,500)),d=!1}function x(i,l){if(i){typeof i=="function"&&(i=i());let a=ke(),m=i.length,g=window["xplay-page"],f=window["xplay-frame"];console.log(m===1?`  ${i}`:JSON.stringify(i,null,2)),window.ws__send("autofill",{autofill:i,browser:a,_page:g,_frame:f},l)}}window.mitm.fn.play=i=>new Promise(function(l,a){try{x(i,l)}catch(m){a(m)}});function L(i){let{autofill:l}=window.mitm;x(l)}function I(i){let{macrokeys:l}=window.mitm;if(i.ctrlKey&&i.key==="Shift")d=!d,s.right3.style=t+(d?"display: none;":""),s.right.style=n+(d?"display: none;":""),s.left.style=e+(d?"display: none;":"");else if(i.ctrlKey&&i.altKey&&(console.log({macro:`ctrl + alt + ${i.code}`}),l)){let a=l[i.code];if(a&&(a=a(),Array.isArray(a))){let m=0,g=setInterval(()=>{let f=a[m];f.match(/^ *[=-]>/)&&(f=`${CssSelectorGenerator.getCssSelector(document.activeElement)} ${f}`),x([f]),m+=1,m>=a.length&&clearInterval(g)},100)}}}if(!window.chrome)return;chrome.tabs||(document.querySelector("html").addEventListener("keydown",I),window.addEventListener("urlchanged",$),window.addEventListener("DOMContentLoaded",()=>{let i=document.querySelector("html"),l=i.firstElementChild,a=document.createElement("style"),m=document.createElement("div"),g=document.createElement("div"),f=document.createElement("div"),q='<button class="btn-autofill">Autofill</button>';a.innerHTML="button.mitm-btn:hover{text-decoration:underline;}",m.innerHTML='<span class="bgroup-right"></span>',g.innerHTML=`<span class="bgroup-right"></span>${q}`,f.innerHTML='<span class="bgroup-left"></span>',g.className="mitm autofill-container",f.className="mitm autofill-container",m.style=t,g.style=n,f.style=e,i.insertBefore(a,l),i.insertBefore(m,l),i.insertBefore(g,l),i.insertBefore(f,l),setTimeout(()=>{s.right3=m,s.right=g,s.left=f,u.style=`${o}background-color: azure;`,_.right3=m.children[0],_.right=g.children[0],_.left=f.children[0],u=g.children[1],u.onclick=L,$(c),ge()},0)}));let{location:T}=document,A=T.href;function R(){A!=T.href&&(window.dispatchEvent(c),A=T.href)}let pe=history.pushState;history.pushState=function(){pe.apply(history,arguments),R()};let H=new MutationObserver(R);function ge(){H.disconnect();let i=document.querySelector("body");H.observe(i,{childList:!0,subtree:!0})}}});var ce=y((Ve,re)=>{function $e(n,e=500){let t;return function(){let o=this,c=arguments;t&&clearTimeout(t),t=setTimeout(()=>{n.apply(o,c)},e)}}re.exports=$e});var ae=y((Xe,le)=>{var Se=S();le.exports=()=>{let n=Se(),e=window.mitm.routes[n],{_subns:t}=e._childns;return t&&mitm.routes[t]&&(e=mitm.routes[t]),e}});var we=y((Ze,de)=>{var Ee=S(),Le=ce(),Te=O(),Ce=ae();de.exports=()=>{if(location.origin.match("chrome-extension"))return;let{hostname:n}=location,e={},t={},o=Ce();if(o&&o.screenshot){let{observer:p}=o.screenshot;for(let r in p){let h={};if(p[r]===!0&&(h={title:"notitle",insert:!0,remove:!0}),typeof p[r]!="string")h={title:"nocapture",insert:!1,remove:!1};else{let w=p[r].split(":");w[1].split(",").map(v=>{h[v]=!0}),h.title=w[0]}e[r]=h,t[r]={insert:!1,remove:!0}}}let c,s,d=Ee(),u=Te(),_=function(){o&&o.screenshot&&(c=o.screenshot.observer);let p=window["xplay-page"];for(let r in t){let h=document.body.querySelectorAll(r);if(h.length){if(!t[r].insert){if(t[r].insert=!0,t[r].remove!==void 0&&(t[r].remove=!1),c&&typeof c[r]=="function"){let w=h[0]||h;w._ws_count===void 0&&(w._ws_count=0),w._ws_count+=1,w._ws_count<2&&c[r](w)}e[r].insert&&(s=location.pathname.replace(/^\//,"").replace(/\//g,"-"),s=`${s}-${e[r].title}-insert`,window.ws__send("screenshot",{namespace:d,_page:p,host:n,fname:s,browser:u}))}}else t[r].remove||(t[r].remove=!0,t[r].insert=!1,e[r].remove&&(s=location.pathname.replace(/^\//,"").replace(/\//g,"-"),s=`${s}-${e[r].title}-remove`,window.ws__send("screenshot",{namespace:d,_page:p,host:n,fname:s,browser:u})))}};document.addEventListener("DOMContentLoaded",()=>{new MutationObserver(Le(_,100)).observe(document.body,{attributes:!0,childList:!0,subtree:!0})})}});var ue=y((et,me)=>{var Me="Wabcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZh",Oe=(n=8)=>{let e="";for(;n-- >0;)e+=Me[Math.random()*64|0];return e};me.exports=()=>{let{_ws:n}=window;window.ws_broadcast=(e,t=!0)=>{let o={data:e,_all:t};n.send(`broadcast${JSON.stringify(o)}`)},window.ws_emitpage=(e,t="")=>{let o={data:e,regex:t};n.send(`emitpage${JSON.stringify(o)}`)},window.ws__style=(e,t=!0)=>{let o={data:e,_all:t};n.send(`_style${JSON.stringify(o)}`)},window.ws__ping=e=>{let t={data:e};n.send(`_ping${JSON.stringify(t)}`)},window.ws__help=()=>{n.send("_help{}")},window.ws__open=e=>{let t={data:e};n.send(`_open${JSON.stringify(t)}`)},window.ws__send=(e,t,o)=>{let{__flag:c}=window.mitm,s=Oe(),d=`${e}:${s}`;window._ws_queue[d]=o||(_=>{}),setTimeout(function(){window._ws_queue[d]&&(delete window._ws_queue[d],console.log(">>> ws timeout!",d))},5e3);let u=`${d}${JSON.stringify({data:t})}`;c["ws-message"]&&console.log("_ws.send",e),n.send(u)}}});var _e=y((tt,fe)=>{var Ie=S(),z,k={};fe.exports=()=>{let n=function(e){let{hostname:t}=location,o=Ie(),c=location.pathname.replace(/^\//,"").replace(/\//g,"-"),{blockedURI:s,disposition:d,documentURI:u,effectiveDirective:_,originalPolicy:p,timeStamp:r,type:h,violatedDirective:w}=e,v=`[${d}] ${u}`;k[v]||(k[v]={}),k[v]._general_||(k[v]._general_={policy:p,namespace:o,host:t,path:c});let $=k[v];$[w]||($[w]={});let x=$[w];x[s]||(x[s]={});let L=p.match(`${w} [^;]+;`),I=L?L[0]:_;x[s]={directive:I,timeStamp:r,type:h},z&&clearTimeout(z),z=setTimeout(()=>{console.log(">>> CSP:",k),k={}},4e3)};window.mitm.client.csp&&document.addEventListener("securitypolicyviolation",n)}});var Ne=K(),ze=X(),Ae=oe(),Re=ie(),He=we(),Je=ue(),Be=_e();Ne();ze();Ae();Re();He();Je();Be();console.log("ws-client loaded...");})();
//# sourceMappingURL=ws-client.js.map
