(()=>{var y=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var K=y((Pe,P)=>{P.exports=()=>{function n(e){window.mitm.client.postmessage&&console.log(`>>> Postmessage: ${e.origin} => https://${location.host}`,e.data)}window.addEventListener("message",n,!1)}});var G=y((Ke,U)=>{U.exports=()=>{let n;return{_help({data:e}){console.log(e)},_ping({data:e}){console.log(e)},_open({data:e}){let t="directories=0,titlebar=0,toolbar=0,location=0,status=0,menubar=0,width=800,height=600";n=window.open(e.url,"_logs",t),n.blur()},_style({data:e}){let{q:t,css:o}=e;document.querySelectorAll(t).forEach(c=>c.style.cssText=o)},_saveTags({routes:e}){location.origin.match("chrome-extension")||(window.mitm.routes=e)},_files({data:e,typ:t}){let{files:o}=window.mitm;console.warn(`receive brodcast ${t}`);for(let c in o[`${t}_events`])console.warn(o[`${t}_events`][c]+""),o[`${t}_events`][c](e)},_setClient({data:e}){console.log("_setClient",e),window.mitm.client=e}}}});var Y=y((Ue,W)=>{var he=G(),j=he();W.exports=(n,e)=>{window.mitm.argv.debug&&(e.length>40?console.log(">>> ws-message: `%s...`",e.slice(0,40)):console.log(">>> ws-message: `%s`",e));let t=e.replace(/\s+$/,"").match(/^ *([\w:]+) *(\{.*)/);if(t){let[,o,c]=t;try{typeof c=="string"&&(c=JSON.parse(c))}catch(s){console.error(c,s)}if(window._ws_queue[o]){let s=window._ws_queue[o];delete window._ws_queue[o],s(c.data)}else j[o]&&j[o].call(n,c)}}});var Q=y((Ge,F)=>{F.exports=()=>{let n;try{n=window.self!==window.top}catch(e){n=!0}return n?"iframe":"window"}});var X=y((We,V)=>{var ye=Y(),ve=Q();V.exports=()=>{window._ws_queue={},window._ws_connected=!1;let{__flag:n}=window.mitm;window._ws_connect===void 0&&(window._ws_connect={});let e=a=>{function m(){for(let f in window._ws_connect)window._ws_connected_send=!0,console.warn(window._ws_connect[f]+""),window._ws_connect[f](a)}n["ws-connect"]&&console.log("ws: open connection"),console.timeEnd("ws"),window._ws_connected=!0,setTimeout(m,1),setTimeout(()=>{window._ws_connected_send||(console.error("RETRY.........."),m())},10)},t=function(){n["ws-connect"]&&console.log("ws: close connection")},o=function(a){ye(event,event.data)},c=`wss://localhost:3001/ws?page=${ve()}&url=${document.URL.split("?")[0]}`,s=new WebSocket(c);console.time("ws"),window._ws=s,s.onopen=e,s.onclose=t,s.onmessage=o,n["ws-connect"]&&console.log("ws: init connection")}});var S=y((je,Z)=>{Z.exports=()=>{let{hostname:n}=location,e;function t(o){return o.replace(/\./g,"\\.").replace(/\?/g,"\\?")}for(let o in window.mitm.routes)if(n.match(t(o.replace(/~/,"[^.]*")))){e=o;break}return e}});var O=y((Ye,ee)=>{ee.exports=()=>{let{vendor:n}=navigator;return{"":"firefox","Google Inc.":"chromium","Apple Computer, Inc.":"webkit"}[n]}});var oe=y((Fe,te)=>{var ne=S(),be=O(),E;function xe(n){if(mitm.argv.lazyclick){if(mitm.screenshot){window.mitm.screenshot=void 0,console.log(">>> delay action");return}if(E){E=void 0;return}}let e=ne(),t=be(),o=location.origin.replace("://","~~"),c=window.mitm.routes[e],{selector:s}=c.screenshot,a=document.body.querySelectorAll(s),m=location.pathname.replace(/^\//g,"~"),f=mitm.argv.lazyclick===!0?700:mitm.argv.lazyclick;for(let _ of a){let r=n.target;for(;_!==r&&r!==document.body;)r=r.parentNode;if(r!==document.body){let h=window["xplay-page"],w={namespace:e,_page:h,host:o,browser:t};w.fname=m==="~"?"~_":m,window.ws__send("screenshot",w),mitm.argv.lazyclick&&(window.mitm.screenshot=n.target,n.stopImmediatePropagation(),n.stopPropagation(),n.preventDefault(),setTimeout(()=>{E=window.mitm.screenshot,E?(E.click(),E=void 0):console.log("delay action undefined")},f));return}}}te.exports=()=>{let n=window.mitm.routes[ne()];n&&n.screenshot&&window.addEventListener("DOMContentLoaded",()=>{document.querySelector("body").addEventListener("click",xe)})}});var ie=y((Qe,se)=>{var qe=S(),ke=O();se.exports=()=>{let n="position: fixed;z-index: 9999;right: 3px;",e="position: fixed;z-index: 9999;left:  3px;",t="position: fixed;z-index: 9999;right: 3px; top: 20px; text-align: end;",o="border: none;border-radius: 15px;font-size: 10px;cursor: pointer;",c=new Event("urlchanged"),s={right3:{},right:{},left:{}},a=!1,m={},f={right3:{},right:{},left:{}},_;function r(i){let[l,d]=i.split("=>").map(u=>u.trim());return l=l.replace(/\./g,"\\.").replace(/\?/g,"\\?"),{path:l,msg:d}}function h(i,l){let d;for(let u in i){let[p,g,q]=u.split("|"),b=document.createElement("button"),C=i[u];b.onclick=N=>{let M=C(N);Array.isArray(M)&&x(M)},b.innerText=p,b.classList.add("mitm-btn"),b.classList.add(`${l}`),b.classList.add(q||p),b.style=o+(g?`background: ${g};`:""),f[l].appendChild(b),l==="right"?(d=document.createElement("span"),d.innerHTML="&nbsp;"):(d=document.createElement("pre"),d.style="margin: 0px;"),f[l].appendChild(d)}}function w(i,l){f[l]&&(f[l].innerHTML="",h(i,l))}let v;function $(i){let l=qe();if(window.mitm.autofill&&delete window.mitm.autofill,window.mitm.autointerval&&(clearInterval(_),delete window.mitm.autointerval),window.mitm.autobuttons&&delete window.mitm.autobuttons,window.mitm.rightbuttons&&delete window.mitm.rightbuttons,window.mitm.leftbuttons&&delete window.mitm.leftbuttons,window.mitm.macrokeys&&delete window.mitm.macrokeys,l){let{href:u,origin:p}=T,g=u.replace(p,""),{_macros_:q,macros:b}=window.mitm;for(let C in b){let{path:N,msg:M}=r(C);g.match(N)&&(m.innerHTML=M||"Autofill",q&&q(),b[C](),v&&(clearTimeout(v),v=void 0),v=setTimeout(()=>{let{autobuttons:J,rightbuttons:B,leftbuttons:D}=window.mitm;B&&w(B,"right3"),J&&w(J,"right"),D&&w(D,"left")},0))}}s.right3.style=t,s.right.style=n,s.left.style=e;let d=window.mitm.autofill;m.style=o+(d?"background-color: azure;":"display: none;"),typeof window.mitm.autointerval=="function"&&(_=setInterval(window.mitm.autointerval,500)),a=!1}function x(i){if(i){typeof i=="function"&&(i=i());let l=ke(),d=i.length,u=window["xplay-page"],p=window["xplay-frame"];console.log(d===1?`  ${i}`:JSON.stringify(i,null,2)),window.ws__send("autofill",{autofill:i,browser:l,_page:u,_frame:p})}}window.mitm.fn.play=x;function L(i){let{autofill:l}=window.mitm;x(l)}function I(i){let{macrokeys:l}=window.mitm;if(i.ctrlKey&&i.key==="Shift")a=!a,s.right3.style=t+(a?"display: none;":""),s.right.style=n+(a?"display: none;":""),s.left.style=e+(a?"display: none;":"");else if(i.ctrlKey&&i.altKey&&(console.log({macro:`ctrl + alt + ${i.code}`}),l)){let d=l[i.code];if(d&&(d=d(),Array.isArray(d))){let u=0,p=setInterval(()=>{let g=d[u];g.match(/^ *[=-]>/)&&(g=`${CssSelectorGenerator.getCssSelector(document.activeElement)} ${g}`),x([g]),u+=1,u>=d.length&&clearInterval(p)},100)}}}if(!window.chrome)return;chrome.tabs||(document.querySelector("html").addEventListener("keydown",I),window.addEventListener("urlchanged",$),window.addEventListener("DOMContentLoaded",()=>{let i=document.querySelector("html"),l=i.firstElementChild,d=document.createElement("style"),u=document.createElement("div"),p=document.createElement("div"),g=document.createElement("div"),q='<button class="btn-autofill">Autofill</button>';d.innerHTML="button.mitm-btn:hover{text-decoration:underline;}",u.innerHTML='<span class="bgroup-right"></span>',p.innerHTML=`<span class="bgroup-right"></span>${q}`,g.innerHTML='<span class="bgroup-left"></span>',p.className="mitm autofill-container",g.className="mitm autofill-container",u.style=t,p.style=n,g.style=e,i.insertBefore(d,l),i.insertBefore(u,l),i.insertBefore(p,l),i.insertBefore(g,l),setTimeout(()=>{s.right3=u,s.right=p,s.left=g,m.style=`${o}background-color: azure;`,f.right3=u.children[0],f.right=p.children[0],f.left=g.children[0],m=p.children[1],m.onclick=L,$(c),ge()},0)}));let{location:T}=document,A=T.href;function R(){A!=T.href&&(window.dispatchEvent(c),A=T.href)}let pe=history.pushState;history.pushState=function(){pe.apply(history,arguments),R()};let H=new MutationObserver(R);function ge(){H.disconnect();let i=document.querySelector("body");H.observe(i,{childList:!0,subtree:!0})}}});var ce=y((Ve,re)=>{function $e(n,e=500){let t;return function(){let o=this,c=arguments;t&&clearTimeout(t),t=setTimeout(()=>{n.apply(o,c)},e)}}re.exports=$e});var ae=y((Xe,le)=>{var Se=S();le.exports=()=>{let n=Se(),e=window.mitm.routes[n],{_subns:t}=e._childns;return t&&mitm.routes[t]&&(e=mitm.routes[t]),e}});var we=y((Ze,de)=>{var Ee=S(),Le=ce(),Te=O(),Ce=ae();de.exports=()=>{if(location.origin.match("chrome-extension"))return;let{hostname:n}=location,e={},t={},o=Ce();if(o&&o.screenshot){let{observer:_}=o.screenshot;for(let r in _){let h={};if(_[r]===!0&&(h={title:"notitle",insert:!0,remove:!0}),typeof _[r]!="string")h={title:"nocapture",insert:!1,remove:!1};else{let w=_[r].split(":");w[1].split(",").map(v=>{h[v]=!0}),h.title=w[0]}e[r]=h,t[r]={insert:!1,remove:!0}}}let c,s,a=Ee(),m=Te(),f=function(){o&&o.screenshot&&(c=o.screenshot.observer);let _=window["xplay-page"];for(let r in t){let h=document.body.querySelectorAll(r);if(h.length){if(!t[r].insert){if(t[r].insert=!0,t[r].remove!==void 0&&(t[r].remove=!1),c&&typeof c[r]=="function"){let w=h[0]||h;w._ws_count===void 0&&(w._ws_count=0),w._ws_count+=1,w._ws_count<2&&c[r](w)}e[r].insert&&(s=location.pathname.replace(/^\//,"").replace(/\//g,"-"),s=`${s}-${e[r].title}-insert`,window.ws__send("screenshot",{namespace:a,_page:_,host:n,fname:s,browser:m}))}}else t[r].remove||(t[r].remove=!0,t[r].insert=!1,e[r].remove&&(s=location.pathname.replace(/^\//,"").replace(/\//g,"-"),s=`${s}-${e[r].title}-remove`,window.ws__send("screenshot",{namespace:a,_page:_,host:n,fname:s,browser:m})))}};document.addEventListener("DOMContentLoaded",()=>{new MutationObserver(Le(f,100)).observe(document.body,{attributes:!0,childList:!0,subtree:!0})})}});var ue=y((et,me)=>{var Me="Wabcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZh",Oe=(n=8)=>{let e="";for(;n-- >0;)e+=Me[Math.random()*64|0];return e};me.exports=()=>{let{_ws:n}=window;window.ws_broadcast=(e,t=!0)=>{let o={data:e,_all:t};n.send(`broadcast${JSON.stringify(o)}`)},window.ws_emitpage=(e,t="")=>{let o={data:e,regex:t};n.send(`emitpage${JSON.stringify(o)}`)},window.ws__style=(e,t=!0)=>{let o={data:e,_all:t};n.send(`_style${JSON.stringify(o)}`)},window.ws__ping=e=>{let t={data:e};n.send(`_ping${JSON.stringify(t)}`)},window.ws__help=()=>{n.send("_help{}")},window.ws__open=e=>{let t={data:e};n.send(`_open${JSON.stringify(t)}`)},window.ws__send=(e,t,o)=>{let{__flag:c}=window.mitm,s=Oe(),a=`${e}:${s}`;window._ws_queue[a]=o||(f=>{}),setTimeout(function(){window._ws_queue[a]&&(delete window._ws_queue[a],console.log(">>> ws timeout!",a))},5e3);let m=`${a}${JSON.stringify({data:t})}`;c["ws-message"]&&console.log("_ws.send",e),n.send(m)}}});var _e=y((tt,fe)=>{var Ie=S(),z,k={};fe.exports=()=>{let n=function(e){let{hostname:t}=location,o=Ie(),c=location.pathname.replace(/^\//,"").replace(/\//g,"-"),{blockedURI:s,disposition:a,documentURI:m,effectiveDirective:f,originalPolicy:_,timeStamp:r,type:h,violatedDirective:w}=e,v=`[${a}] ${m}`;k[v]||(k[v]={}),k[v]._general_||(k[v]._general_={policy:_,namespace:o,host:t,path:c});let $=k[v];$[w]||($[w]={});let x=$[w];x[s]||(x[s]={});let L=_.match(`${w} [^;]+;`),I=L?L[0]:f;x[s]={directive:I,timeStamp:r,type:h},z&&clearTimeout(z),z=setTimeout(()=>{console.log(">>> CSP:",k),k={}},4e3)};window.mitm.client.csp&&document.addEventListener("securitypolicyviolation",n)}});var Ne=K(),ze=X(),Ae=oe(),Re=ie(),He=we(),Je=ue(),Be=_e();Ne();ze();Ae();Re();He();Je();Be();console.log("ws-client loaded...");})();
//# sourceMappingURL=ws-client.js.map
